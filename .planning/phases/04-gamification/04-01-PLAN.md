---
phase: 04-gamification
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/gamification.ts
  - frontend/lib/hooks/useGamificationStats.ts
  - frontend/lib/store.ts
autonomous: true
requirements:
  - GAMIFY-01
  - GAMIFY-02
  - GAMIFY-03
  - GAMIFY-04
  - GAMIFY-06

must_haves:
  truths:
    - "Daily completion count is derived from tasks completed today (status=done, updated_at matches today)"
    - "Streak calculation preserves the i===0 early-continue guard (no completions today does not break streak)"
    - "Personal best is read from localStorage on mount and updated whenever current streak exceeds it"
    - "Impact hours are derived from sum of estimated_duration (minutes) of done-today tasks, divided by 60"
    - "Impact message returns empty string when impactHours is 0 (no message shown for zero data)"
    - "eodSummaryEnabled is persisted to sessionStorage via Zustand partialize"
  artifacts:
    - path: "frontend/lib/gamification.ts"
      provides: "Pure utility functions: getPersonalBest, updatePersonalBest, calculateImpactHours, formatImpactMessage"
      exports:
        - getPersonalBest
        - updatePersonalBest
        - calculateImpactHours
        - formatImpactMessage
    - path: "frontend/lib/hooks/useGamificationStats.ts"
      provides: "GamificationStats interface and useGamificationStats hook"
      exports:
        - GamificationStats
        - useGamificationStats
    - path: "frontend/lib/store.ts"
      provides: "eodSummaryEnabled boolean + setter in AppState"
      contains: "eodSummaryEnabled"
  key_links:
    - from: "frontend/lib/hooks/useGamificationStats.ts"
      to: "frontend/lib/gamification.ts"
      via: "import { getPersonalBest, updatePersonalBest, calculateImpactHours } from '@/lib/gamification'"
      pattern: "from '@/lib/gamification'"
    - from: "frontend/lib/store.ts"
      to: "partialize"
      via: "eodSummaryEnabled added to partialize object"
      pattern: "eodSummaryEnabled"
---

<objective>
Build the pure utility foundation for Phase 4 gamification: a set of pure functions for personal best tracking, impact calculation, and streak copy — plus the `useGamificationStats` hook that extends the existing inline stats calculation from page.tsx, and a store extension for the EOD opt-in preference.

Purpose: All UI components in Plans 02 and 03 depend on these utilities and the `GamificationStats` interface. Building them first enables parallel-free, dependency-clean component development.
Output: `gamification.ts` (pure utils), `useGamificationStats.ts` (hook + type), `store.ts` (eodSummaryEnabled field added).
</objective>

<execution_context>
@/home/rbrown/.claude/get-shit-done/workflows/execute-plan.md
@/home/rbrown/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gamification/04-CONTEXT.md
@.planning/phases/04-gamification/04-RESEARCH.md
@frontend/lib/store.ts
@frontend/app/page.tsx
@frontend/lib/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gamification.ts pure utility library</name>
  <files>frontend/lib/gamification.ts</files>
  <action>
Create `frontend/lib/gamification.ts` as a new file with pure, SSR-safe utility functions:

```typescript
const PERSONAL_BEST_KEY = 'liminal-streak-best'

export function getPersonalBest(): number {
  if (typeof window === 'undefined') return 0
  const stored = localStorage.getItem(PERSONAL_BEST_KEY)
  return stored ? parseInt(stored, 10) : 0
}

export function updatePersonalBest(currentStreak: number): number {
  if (typeof window === 'undefined') return currentStreak
  const best = getPersonalBest()
  if (currentStreak > best) {
    localStorage.setItem(PERSONAL_BEST_KEY, String(currentStreak))
    return currentStreak
  }
  return best
}
```

For `calculateImpactHours`: filter tasks where status==='done' AND updated_at exists AND new Date(updated_at).toDateString() === new Date().toDateString() AND estimated_duration is truthy. Sum estimated_duration (in minutes) of matching tasks. Return sum / 60. Import Task type from '@/lib/api'.

For `formatImpactMessage(hours: number): string`:
- If hours === 0, return '' (empty string — no message shown when no duration data)
- If hours < 0.5, return 'You freed up some time today'
- Otherwise: round to nearest 0.5 (Math.round(hours * 2) / 2), return `You freed up ${rounded === 1 ? '1 hour' : `${rounded} hours`} today`

The Task type import: use `import { Task } from '@/lib/api'`. Do NOT import from relative paths.

SSR guards: getPersonalBest and updatePersonalBest both check `typeof window === 'undefined'` before accessing localStorage.
  </action>
  <verify>
Run `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1 | head -30` — should show no errors related to gamification.ts.
  </verify>
  <done>
`frontend/lib/gamification.ts` exists and exports: getPersonalBest, updatePersonalBest, calculateImpactHours, formatImpactMessage. TypeScript compiles without errors on the new file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useGamificationStats hook</name>
  <files>frontend/lib/hooks/useGamificationStats.ts</files>
  <action>
Create `frontend/lib/hooks/useGamificationStats.ts` as a new file.

Export the `GamificationStats` interface:
```typescript
export interface GamificationStats {
  doneToday: number
  currentStreak: number
  personalBest: number
  impactHours: number
}
```

Export `useGamificationStats(tasks: Task[]): GamificationStats` as a hook using `useMemo`.

The useMemo body must implement exactly the same streak logic as the existing `stats` useMemo in `frontend/app/page.tsx` (lines 172-207) — CRITICAL: preserve the `i === 0` early-continue guard:

```typescript
// Consecutive active days (1 task completed = active day)
const completedDates = new Set(
  tasks
    .filter(t => t.status === 'done' && t.updated_at)
    .map(t => new Date(t.updated_at!).toDateString())
)

let currentStreak = 0
for (let i = 0; i < 365; i++) {
  const d = new Date()
  d.setDate(d.getDate() - i)
  const dStr = d.toDateString()

  if (completedDates.has(dStr)) {
    currentStreak++
  } else if (i === 0) {
    // Today with no completions yet doesn't break streak
    continue
  } else {
    break
  }
}
```

After computing currentStreak, call `updatePersonalBest(currentStreak)` and assign result to `personalBest`. This ensures personal best updates reactively on task completions within the same session (not just on page load).

Also compute `doneToday` (tasks where status==='done', updated_at exists, and new Date(updated_at).toDateString() matches today).

Compute `impactHours` by calling `calculateImpactHours(tasks)` from '@/lib/gamification'.

Return `{ doneToday, currentStreak, personalBest, impactHours }`.

Imports: `useMemo` from 'react', `Task` from '@/lib/api', `updatePersonalBest, calculateImpactHours` from '@/lib/gamification'.
  </action>
  <verify>
Run `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1 | head -30` — no new TypeScript errors. Confirm the file exports GamificationStats interface and useGamificationStats function.
  </verify>
  <done>
`frontend/lib/hooks/useGamificationStats.ts` exists. Exports `GamificationStats` (interface) and `useGamificationStats` (hook). TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend Zustand store with EOD opt-in preference</name>
  <files>frontend/lib/store.ts</files>
  <action>
Modify `frontend/lib/store.ts` to add EOD summary opt-in state.

In the `AppState` interface, add:
```typescript
// Gamification: EOD summary opt-in
eodSummaryEnabled: boolean
setEodSummaryEnabled: (enabled: boolean) => void
```

In the `create()` body, add:
```typescript
eodSummaryEnabled: false,  // Off by default per CONTEXT.md decision
setEodSummaryEnabled: (enabled) => set({ eodSummaryEnabled: enabled }),
```

In the `partialize` function, add `eodSummaryEnabled: state.eodSummaryEnabled` to the returned object. This persists the opt-in preference to sessionStorage so it survives page refresh within a browser session.

IMPORTANT: Do not change any existing fields, logic, or the storage adapter (sessionStorage). Only add the new fields.
  </action>
  <verify>
Run `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1 | head -30` — no TypeScript errors. Confirm `eodSummaryEnabled` appears in the partialize return object.
  </verify>
  <done>
`frontend/lib/store.ts` contains `eodSummaryEnabled: boolean`, `setEodSummaryEnabled`, and `eodSummaryEnabled` in partialize. TypeScript compiles without errors. No existing fields were changed.
  </done>
</task>

</tasks>

<verification>
Run `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1` — zero errors.

Confirm files exist:
- `frontend/lib/gamification.ts` with exports: getPersonalBest, updatePersonalBest, calculateImpactHours, formatImpactMessage
- `frontend/lib/hooks/useGamificationStats.ts` with exports: GamificationStats, useGamificationStats
- `frontend/lib/store.ts` contains eodSummaryEnabled in interface, state, and partialize
</verification>

<success_criteria>
- gamification.ts exports 4 pure functions with SSR guards
- useGamificationStats hook preserves the i===0 early-continue streak guard
- personalBest updates reactively (updatePersonalBest called inside useMemo)
- eodSummaryEnabled defaults to false, is persisted to sessionStorage
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-gamification/04-01-SUMMARY.md` using the summary template.
</output>

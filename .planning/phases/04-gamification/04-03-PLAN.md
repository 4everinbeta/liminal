---
phase: 04-gamification
plan: "03"
type: execute
wave: 3
depends_on:
  - "04-01"
  - "04-02"
files_modified:
  - frontend/app/page.tsx
autonomous: false
requirements:
  - GAMIFY-01
  - GAMIFY-02
  - GAMIFY-03
  - GAMIFY-04
  - GAMIFY-05
  - GAMIFY-06

must_haves:
  truths:
    - "StatsBar renders above the task list in both focus mode and planning mode"
    - "Stats update immediately when a task is completed (optimistic local state update feeds useGamificationStats)"
    - "EodSummaryToast appears at 5pm (or on mount if already past 5pm) when eodSummaryEnabled is true"
    - "An inline toggle in the dashboard lets users enable/disable the EOD summary"
    - "The inline stats grid previously in focus mode is removed (replaced by StatsBar)"
    - "The existing stats useMemo in page.tsx is removed (logic moved to useGamificationStats)"
    - "User sees daily completion count, streak with personal best, and optional impact message"
  artifacts:
    - path: "frontend/app/page.tsx"
      provides: "Dashboard wired with StatsBar, EodSummaryToast, useGamificationStats, eodSummaryEnabled toggle"
      contains: "StatsBar"
  key_links:
    - from: "frontend/app/page.tsx"
      to: "frontend/components/StatsBar.tsx"
      via: "import StatsBar from '@/components/StatsBar'; rendered above mode-specific content"
      pattern: "<StatsBar"
    - from: "frontend/app/page.tsx"
      to: "frontend/components/EodSummaryToast.tsx"
      via: "useEodSummaryScheduler + EodSummaryToast rendered in JSX"
      pattern: "EodSummaryToast"
    - from: "frontend/app/page.tsx"
      to: "frontend/lib/hooks/useGamificationStats.ts"
      via: "useGamificationStats(tasks) replaces inline stats useMemo"
      pattern: "useGamificationStats"
---

<objective>
Wire the StatsBar and EodSummaryToast components into `page.tsx`, replacing the existing inline stats grid. Add the EOD opt-in toggle inline on the dashboard. Then verify the complete gamification experience works end-to-end with a human-verification checkpoint.

Purpose: All three GAMIFY requirements become visible to the user as a cohesive experience — ambient stats bar, live-updating counters on task completion, and optional end-of-day celebration.
Output: Updated `page.tsx` with full gamification integration. Human confirms the feature works as designed.
</objective>

<execution_context>
@/home/rbrown/.claude/get-shit-done/workflows/execute-plan.md
@/home/rbrown/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-gamification/04-CONTEXT.md
@.planning/phases/04-gamification/04-RESEARCH.md
@.planning/phases/04-gamification/04-01-SUMMARY.md
@.planning/phases/04-gamification/04-02-SUMMARY.md
@frontend/app/page.tsx
@frontend/lib/store.ts
@frontend/components/StatsBar.tsx
@frontend/components/EodSummaryToast.tsx
@frontend/lib/hooks/useGamificationStats.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire gamification into page.tsx and add EOD toggle</name>
  <files>frontend/app/page.tsx</files>
  <action>
Modify `frontend/app/page.tsx` to integrate the gamification layer. Make these changes:

**1. Add new imports at the top:**
```typescript
import { StatsBar } from '@/components/StatsBar'
import { EodSummaryToast, useEodSummaryScheduler } from '@/components/EodSummaryToast'
import { useGamificationStats } from '@/lib/hooks/useGamificationStats'
```

**2. Add store fields to the useAppStore destructure:**
```typescript
const { eodSummaryEnabled, setEodSummaryEnabled, /* ...existing fields... */ } = useAppStore()
```

**3. Replace the inline `stats` useMemo with the hook:**

Remove the existing `stats` useMemo block (lines 172-207 in the current file — the one computing doneToday, backlog, inProgress, streak). Replace it with:
```typescript
const gamificationStats = useGamificationStats(tasks)
```

Keep the `activeTasks` useMemo (the one filtering tasks where status !== 'done') — that is still needed for the task list display.

**4. Add EOD scheduler hook after the gamificationStats line:**
```typescript
const { showSummary, dismissSummary } = useEodSummaryScheduler(eodSummaryEnabled, gamificationStats)
```

**5. Place StatsBar above mode-specific content:**

In the JSX, immediately after the notification soft-ask banner block and the error block (before the `{isFocusMode && ...}` conditional), add:
```tsx
{/* Gamification Stats Bar — shown in both focus and planning mode */}
<StatsBar stats={gamificationStats} />
```

**6. Remove the old inline stats grid from focus mode:**

Inside the focus mode section (`{isFocusMode && (...)}`), find and remove the 3-column stats grid `<div className="grid grid-cols-3 gap-4">...</div>` that renders the doneToday, streak, and active count cards. StatsBar now handles this display globally. The active task card and task queue preview remain unchanged.

**7. Add EOD toggle in planning mode only:**

Inside the planning mode section (`{!isFocusMode && (...)}`), add a small toggle row at the very top, before the Quick Capture card:
```tsx
{/* EOD Summary opt-in toggle */}
<div className="flex items-center justify-end gap-2 text-xs text-gray-400">
  <span>End-of-day summary</span>
  <button
    onClick={() => setEodSummaryEnabled(!eodSummaryEnabled)}
    className={`relative inline-flex h-4 w-8 items-center rounded-full transition-colors ${
      eodSummaryEnabled ? 'bg-primary' : 'bg-gray-200'
    }`}
    aria-label="Toggle end-of-day summary"
  >
    <span
      className={`inline-block h-3 w-3 transform rounded-full bg-white shadow transition-transform ${
        eodSummaryEnabled ? 'translate-x-4' : 'translate-x-0.5'
      }`}
    />
  </button>
</div>
```

**8. Add EodSummaryToast at the bottom of the return JSX (inside the outer div, before the closing tag):**
```tsx
{/* End-of-day summary toast */}
<EodSummaryToast
  stats={gamificationStats}
  isVisible={showSummary}
  onDismiss={dismissSummary}
/>
```

**9. Remove unused imports if any:** If `CheckCircle`, `Flame`, `CircleDashed` from lucide-react are no longer used elsewhere in page.tsx after the inline stats grid removal, remove them from the import line. (CheckCircle is still used in the Complete button and PlanningTaskRow, so keep CheckCircle. Flame and CircleDashed may no longer be needed — check usage before removing.)

**Do NOT change:** PlanningTaskRow component, handleCompleteTask, handleSkipTask, handleDeleteTask, handleSaveTask, fetchTasks, or any other existing logic. Only the stats display and the additions above.
  </action>
  <verify>
Run `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1` — zero TypeScript errors.

Run the dev server: `cd /home/rbrown/workspace/liminal/frontend && npm run dev &` then check for compilation errors in output.
  </verify>
  <done>
`frontend/app/page.tsx` imports and renders StatsBar (above mode content), EodSummaryToast (at JSX root), and uses useGamificationStats instead of the inline stats useMemo. The old 3-column stats grid in focus mode is removed. EOD toggle appears in planning mode. TypeScript compiles with zero errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of complete gamification experience</name>
  <what-built>
Complete Phase 4 gamification layer:
- StatsBar with animated counters (done today, day streak + personal best, optional impact hours) appears above the task list in both focus and planning modes
- Mobile: StatsBar collapses behind "Today's progress" toggle
- Desktop: StatsBar is always visible
- Stats update immediately when a task is marked complete (live counter animation)
- EOD summary toggle in planning mode (off by default) — when enabled, fires at 5pm
- Personal best streak persisted to localStorage across sessions
  </what-built>
  <how-to-verify>
Visit http://localhost:3000 (or the running dev server URL).

1. **Stats bar visibility:** Confirm the stats bar (done today, streak, optional impact) is visible above the task list in both Focus and Plan modes.

2. **Animated counters:** On page load, confirm the numbers animate up from 0 to their current values.

3. **Live update:** Mark a task as complete. Confirm the "done today" counter animates up by 1 immediately (no page refresh needed).

4. **Personal best display:** If you have a multi-day streak, confirm "X days (best: Y)" format when Y > X, or just "X days" when streak equals or exceeds personal best.

5. **Impact message:** If any completed tasks have `estimated_duration` set, confirm the blue "You freed up X hours today" pill appears. If no tasks have duration estimates, confirm the pill is absent (not "0 hours").

6. **Mobile collapse (optional — resize window below 640px):** Confirm stats hide behind "Today's progress ▼" toggle and expand on tap.

7. **EOD toggle:** Switch to Plan mode. Confirm a small "End-of-day summary [toggle]" appears. Toggle it on. Confirm it persists on page refresh.

8. **No incomplete count shown:** Confirm no number representing remaining/backlog tasks appears anywhere in the stats bar or gamification UI.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm the gamification layer works as described, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
TypeScript: `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1` — zero errors.

Human verification confirms:
- StatsBar visible in both modes
- Counters animate on mount and update on task completion
- Personal best shows correctly
- EOD toggle persists
- No incomplete task counts shown
</verification>

<success_criteria>
- StatsBar renders above the task list in both Focus and Plan modes
- Completing a task causes the doneToday AnimatedCounter to tick up immediately (live state update)
- Personal best displays correctly as "X days (best: Y)" format
- Impact message appears only when impactHours > 0
- EOD toggle in planning mode is off by default, persists when enabled
- EodSummaryToast shows wins-only content at 5pm (or immediately on mount if past 5pm and enabled)
- Zero TypeScript errors
- Human verifier approves the experience
</success_criteria>

<output>
After completion, create `.planning/phases/04-gamification/04-03-SUMMARY.md` using the summary template.
</output>

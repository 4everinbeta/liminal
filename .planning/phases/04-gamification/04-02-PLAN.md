---
phase: 04-gamification
plan: "02"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - frontend/components/StatsBar.tsx
  - frontend/components/EodSummaryToast.tsx
autonomous: true
requirements:
  - GAMIFY-01
  - GAMIFY-02
  - GAMIFY-03
  - GAMIFY-04
  - GAMIFY-05
  - GAMIFY-06

must_haves:
  truths:
    - "StatsBar renders doneToday count with an AnimatedCounter that animates from 0 on mount"
    - "StatsBar renders currentStreak with personal best shown in parentheses when personalBest > currentStreak"
    - "StatsBar renders impact message pill only when impactHours > 0"
    - "StatsBar is always visible on desktop (sm: breakpoint) and hidden behind a toggle on mobile"
    - "EodSummaryToast renders wins-only content: tasks completed, impact message if available, streak if > 0"
    - "EodSummaryToast never shows incomplete task count"
    - "EodSummaryToast uses AnimatePresence for mount/unmount animation (slide up from bottom)"
    - "AnimatedCounter uses useSpring + useTransform from framer-motion (not v11 motion/react import path)"
  artifacts:
    - path: "frontend/components/StatsBar.tsx"
      provides: "Animated stats header bar with daily count, streak, personal best, and impact message"
      exports:
        - StatsBar
    - path: "frontend/components/EodSummaryToast.tsx"
      provides: "End-of-day wins summary toast with backdrop, slide-up animation, dismiss button"
      exports:
        - EodSummaryToast
        - useEodSummaryScheduler
  key_links:
    - from: "frontend/components/StatsBar.tsx"
      to: "frontend/lib/hooks/useGamificationStats.ts"
      via: "import { GamificationStats } from '@/lib/hooks/useGamificationStats'"
      pattern: "GamificationStats"
    - from: "frontend/components/StatsBar.tsx"
      to: "framer-motion"
      via: "import { useSpring, useTransform, useMotionValue, motion, AnimatePresence } from 'framer-motion'"
      pattern: "from 'framer-motion'"
    - from: "frontend/components/EodSummaryToast.tsx"
      to: "framer-motion"
      via: "AnimatePresence wraps the toast card for exit animation"
      pattern: "AnimatePresence"
---

<objective>
Build the two new UI components for Phase 4: `StatsBar` (compact animated header bar with daily count, streak, personal best, impact message, mobile collapse) and `EodSummaryToast` (end-of-day wins summary with slide-up animation, backdrop, wins-only content, and scheduler hook). Both components are built against the `GamificationStats` type from Plan 01.

Purpose: Components are built and verified in isolation before being wired into `page.tsx` in Plan 03. This allows full component implementation without touching the live dashboard.
Output: `StatsBar.tsx` and `EodSummaryToast.tsx` ready for integration.
</objective>

<execution_context>
@/home/rbrown/.claude/get-shit-done/workflows/execute-plan.md
@/home/rbrown/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-gamification/04-CONTEXT.md
@.planning/phases/04-gamification/04-RESEARCH.md
@.planning/phases/04-gamification/04-01-SUMMARY.md
@frontend/lib/hooks/useGamificationStats.ts
@frontend/lib/gamification.ts
@frontend/lib/store.ts
@frontend/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatsBar component with Framer Motion animated counters</name>
  <files>frontend/components/StatsBar.tsx</files>
  <action>
Create `frontend/components/StatsBar.tsx` as a new file. Mark it `'use client'` at the top.

**Imports (CRITICAL — use Framer Motion v10 import path, NOT v11):**
```typescript
'use client'
import { useSpring, useTransform, useMotionValue, motion, AnimatePresence } from 'framer-motion'
import { useEffect, useState } from 'react'
import { CheckCircle, Flame, Clock } from 'lucide-react'
import { GamificationStats } from '@/lib/hooks/useGamificationStats'
import { formatImpactMessage } from '@/lib/gamification'
```

**AnimatedCounter sub-component (do NOT export — internal only):**
```typescript
function AnimatedCounter({ value }: { value: number }) {
  const motionValue = useMotionValue(0)
  const spring = useSpring(motionValue, { stiffness: 200, damping: 20, restDelta: 0.001 })
  const rounded = useTransform(spring, (v) => Math.round(v))

  useEffect(() => {
    motionValue.set(value)
  }, [value, motionValue])

  return <motion.span>{rounded}</motion.span>
}
```

Initialize `useMotionValue(0)` always (not with the current value). This creates the count-up from 0 on mount, and smooth transition to new values on update. Both behaviors are correct and intentional.

**StatsPills sub-component (do NOT export — internal only):**
Three pills in a flex-wrap row:
1. Done today pill: CheckCircle icon (text-green-500, size 16) + AnimatedCounter for doneToday + "done today" label
2. Streak pill: Flame icon (text-orange-500, size 16) + AnimatedCounter for currentStreak + label showing "days" + conditional personal best: `{stats.personalBest > stats.currentStreak && ` (best: ${stats.personalBest})`}` — only show personal best annotation when it exceeds current streak
3. Impact pill: Clock icon (text-blue-500, size 16) + impactMsg text — render this pill ONLY when impactMsg is non-empty (`{impactMsg && (<div>...impact pill...</div>)}`)

Each pill: `flex items-center gap-2 bg-white border border-gray-100 rounded-xl px-3 py-2 shadow-sm`
Number text: `text-sm font-semibold`
Label text: `text-xs text-gray-500`

Container: `flex flex-wrap gap-3 w-full`

**StatsBar main export:**
```typescript
export function StatsBar({ stats }: { stats: GamificationStats }) {
  const [expanded, setExpanded] = useState(false)
  const impactMsg = formatImpactMessage(stats.impactHours)

  return (
    <div className="mb-4">
      {/* Mobile toggle — hidden on sm+ */}
      <button
        className="sm:hidden flex items-center gap-1 text-xs text-gray-400 mb-2"
        onClick={() => setExpanded(v => !v)}
        aria-expanded={expanded}
      >
        Today's progress {expanded ? '▲' : '▼'}
      </button>

      {/* Desktop: always visible */}
      <div className="hidden sm:flex gap-3">
        <StatsPills stats={stats} impactMsg={impactMsg} />
      </div>

      {/* Mobile: collapsible */}
      <AnimatePresence>
        {expanded && (
          <motion.div
            className="sm:hidden"
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.2 }}
            style={{ overflow: 'hidden' }}
          >
            <div className="flex gap-3">
              <StatsPills stats={stats} impactMsg={impactMsg} />
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  )
}
```

ADHD design constraints (from CONTEXT.md, non-negotiable):
- Never show incomplete task count in StatsBar
- Personal best shows only when strictly greater than current streak
- Impact pill only renders when impactHours > 0 (empty string from formatImpactMessage means no pill)
  </action>
  <verify>
Run `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1 | head -30` — no TypeScript errors in StatsBar.tsx.
  </verify>
  <done>
`frontend/components/StatsBar.tsx` exists and exports `StatsBar`. TypeScript compiles without errors. Component accepts `GamificationStats` prop, renders 3 pills (done today, streak, optional impact), uses AnimatedCounter with Framer Motion useSpring, collapses on mobile behind toggle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EodSummaryToast component and scheduler hook</name>
  <files>frontend/components/EodSummaryToast.tsx</files>
  <action>
Create `frontend/components/EodSummaryToast.tsx` as a new file. Mark it `'use client'` at the top.

**Imports:**
```typescript
'use client'
import { useEffect, useState } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { GamificationStats } from '@/lib/hooks/useGamificationStats'
import { formatImpactMessage } from '@/lib/gamification'
```

**useEodSummaryScheduler hook (export this):**

The hook accepts `(isEnabled: boolean, stats: GamificationStats)` and returns `{ showSummary: boolean, dismissSummary: () => void }`.

Logic:
1. Initialize `showSummary` state as false.
2. In a useEffect that depends on `[isEnabled]`:
   - If `!isEnabled`, return early (do nothing).
   - Calculate `now = new Date()` and `eodToday = new Date()` with `eodToday.setHours(17, 0, 0, 0)`.
   - Calculate `msUntilEod = eodToday.getTime() - now.getTime()`.
   - If `msUntilEod <= 0` (already past 5pm today):
     - Check `sessionStorage.getItem('eod-summary-shown-date')`.
     - If it equals `now.toDateString()`, do nothing (already shown today).
     - Otherwise, `setShowSummary(true)`.
     - Return (no timeout to set).
   - If `msUntilEod > 0` (before 5pm):
     - `const timeoutId = window.setTimeout(() => setShowSummary(true), msUntilEod)`
     - Return cleanup: `() => clearTimeout(timeoutId)`
3. SSR guard: wrap sessionStorage access with `typeof window !== 'undefined'`.

`dismissSummary` function:
```typescript
const dismissSummary = () => {
  setShowSummary(false)
  if (typeof window !== 'undefined') {
    sessionStorage.setItem('eod-summary-shown-date', new Date().toDateString())
  }
}
```

**EodSummaryToast component (export this):**

Props: `{ stats: GamificationStats; isVisible: boolean; onDismiss: () => void }`

Internal logic:
- `isNewBest`: `stats.currentStreak > 0 && stats.currentStreak === stats.personalBest`
- `impactMsg`: `formatImpactMessage(stats.impactHours)`

Render with `AnimatePresence` at the root. Inside, when `isVisible`:
1. Backdrop `motion.div` with `className="fixed inset-0 bg-black/20 z-40"`, `initial={{ opacity: 0 }}`, `animate={{ opacity: 1 }}`, `exit={{ opacity: 0 }}`, `onClick={onDismiss}`.
2. Toast card `motion.div` with `className="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 z-50 text-center"`, `initial={{ y: 80, opacity: 0 }}`, `animate={{ y: 0, opacity: 1 }}`, `exit={{ y: 80, opacity: 0 }}`, `transition={{ type: 'spring', stiffness: 300, damping: 25 }}`.

Toast content (wins-only, ADHD-safe — never show incomplete count):
- Headline: `isNewBest ? 'New personal best!' : 'Great work today!'` in large text (text-2xl mb-2)
- Stats section (text-sm text-gray-600 mb-4 space-y-1):
  - Always: `Tasks completed: <strong>{stats.doneToday}</strong>`
  - Conditional: `{impactMsg && <div>{impactMsg}</div>}`
  - Conditional: `{stats.currentStreak > 0 && <div>Streak: <strong>{stats.currentStreak} {stats.currentStreak === 1 ? 'day' : 'days'}</strong>{stats.personalBest > 0 && ` (best: ${stats.personalBest})`}</div>}`
- Dismiss button: `onClick={onDismiss}`, text "Close", styled `px-6 py-2 bg-gray-100 text-gray-700 rounded-xl text-sm font-medium hover:bg-gray-200 transition-colors`

CRITICAL: The toast NEVER shows incomplete task count. No "tasks remaining", "backlog count", or any negative framing. Wins only.
  </action>
  <verify>
Run `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1 | head -30` — no TypeScript errors in EodSummaryToast.tsx.
  </verify>
  <done>
`frontend/components/EodSummaryToast.tsx` exists and exports `EodSummaryToast` (component) and `useEodSummaryScheduler` (hook). TypeScript compiles without errors. Toast shows wins-only content, uses AnimatePresence for slide-up animation, sessionStorage persists "shown today" state.
  </done>
</task>

</tasks>

<verification>
Run `cd /home/rbrown/workspace/liminal/frontend && npx tsc --noEmit 2>&1` — zero errors across all new files.

Confirm files exist:
- `frontend/components/StatsBar.tsx` — exports StatsBar
- `frontend/components/EodSummaryToast.tsx` — exports EodSummaryToast, useEodSummaryScheduler

Spot-check ADHD constraints:
- StatsBar has no reference to "backlog", "inProgress", or incomplete counts
- EodSummaryToast has no reference to remaining/incomplete tasks
- formatImpactMessage imported from '@/lib/gamification' (not inline logic)
</verification>

<success_criteria>
- StatsBar animates doneToday and currentStreak with Framer Motion useSpring on mount and task completion
- StatsBar shows personal best only when personalBest > currentStreak
- StatsBar shows impact pill only when impactHours > 0
- StatsBar collapses on mobile behind "Today's progress" toggle
- EodSummaryToast shows wins-only content with spring slide-up animation
- useEodSummaryScheduler fires at 5pm with sessionStorage deduplication
- TypeScript zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-gamification/04-02-SUMMARY.md` using the summary template.
</output>

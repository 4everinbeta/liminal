---
phase: 03-urgency-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/lib/urgency.ts
  - frontend/lib/hooks/useCountdown.ts
  - frontend/lib/hooks/useUrgencyColor.ts
  - frontend/package.json
  - frontend/package-lock.json
autonomous: true

must_haves:
  truths:
    - "Urgency color interpolates green to yellow to orange to red based on deadline proximity"
    - "Countdown returns human-readable time remaining string that updates every second"
    - "Overdue tasks return warm orange color, not shame-inducing red"
    - "Tasks with no due_date return neutral gray color"
    - "Completed tasks return gray regardless of deadline"
  artifacts:
    - path: "frontend/lib/urgency.ts"
      provides: "Urgency utility functions: getUrgencyColor, getUrgencyLevel, isStaleTask"
      exports: ["getUrgencyColor", "getUrgencyLevel", "isStaleTask"]
    - path: "frontend/lib/hooks/useCountdown.ts"
      provides: "requestAnimationFrame-based countdown hook"
      exports: ["useCountdown"]
    - path: "frontend/lib/hooks/useUrgencyColor.ts"
      provides: "Memoized urgency color hook wrapping getUrgencyColor"
      exports: ["useUrgencyColor"]
  key_links:
    - from: "frontend/lib/hooks/useUrgencyColor.ts"
      to: "frontend/lib/urgency.ts"
      via: "import getUrgencyColor"
      pattern: "import.*getUrgencyColor.*from.*urgency"
    - from: "frontend/lib/hooks/useCountdown.ts"
      to: "date-fns"
      via: "formatDistanceToNowStrict for display"
      pattern: "formatDistanceToNowStrict"
---

<objective>
Create the urgency calculation foundation: color interpolation library, countdown hook, and urgency color hook.

Purpose: These utilities are the engine behind ALL visual urgency features. Every task's color, countdown timer, and staleness check flows through these functions. They must be correct, performant, and ADHD-safe (warm overdue colors, not shame-inducing red).

Output: Three files -- urgency.ts (pure utility functions), useCountdown.ts (real-time countdown hook), useUrgencyColor.ts (memoized color hook). Plus chroma-js installed.
</objective>

<execution_context>
@/home/rbrown/.claude/get-shit-done/workflows/execute-plan.md
@/home/rbrown/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-urgency-system/03-RESEARCH.md

@frontend/lib/api.ts (Task interface with due_date, created_at, status, effort_score, estimated_duration)
@frontend/lib/store.ts (Zustand store pattern)
@frontend/lib/hooks/useAutoSave.ts (existing hook pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install chroma-js and create urgency utility library</name>
  <files>
    frontend/package.json
    frontend/package-lock.json
    frontend/lib/urgency.ts
  </files>
  <action>
    1. Install chroma-js: Run `npm install chroma-js@^3.2.0` and `npm install --save-dev @types/chroma-js` from the frontend directory.

    2. Create `frontend/lib/urgency.ts` with these exported functions:

    **getUrgencyColor(dueDate: string | undefined, createdAt: string, status: string): string**
    - If no dueDate or status === 'done': return '#94a3b8' (gray-400, neutral)
    - If overdue (due < now): return '#f97316' (orange-500, warm not shame-inducing -- NOT pure red)
    - Otherwise: calculate progress as `1 - (timeRemaining / totalTime)` where totalTime = due - created, timeRemaining = due - now
    - Use chroma.scale(['#10b981', '#fbbf24', '#f97316', '#ef4444']).mode('hsl').domain([0, 0.5, 0.85, 1])
    - Clamp progress to [0, 1] with Math.max/Math.min
    - Return scale(progress).hex()

    **getUrgencyLevel(dueDate: string | undefined): 'overdue' | 'critical' | 'urgent' | 'soon' | 'safe' | 'none'**
    - No dueDate: return 'none'
    - Past due: 'overdue'
    - Less than 1 hour: 'critical'
    - Less than 4 hours: 'urgent'
    - Less than 24 hours: 'soon'
    - Otherwise: 'safe'

    **isStaleTask(createdAt: string, status: string, staleDays: number = 3): boolean**
    - Return true if status is 'backlog' AND daysSinceCreated > staleDays
    - daysSinceCreated = (Date.now() - new Date(createdAt).getTime()) / (1000 * 60 * 60 * 24)

    Use inline `style={{ backgroundColor: color }}` approach -- do NOT construct dynamic Tailwind class names (they break at build time as noted in RESEARCH.md pitfall 2).
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` compiles without errors
    - `node -e "const c = require('chroma-js'); console.log(c.scale(['green','red']).mode('hsl')(0.5).hex())"` outputs a valid hex color from frontend directory
    - urgency.ts exports all three functions (grep for export function)
  </verify>
  <done>
    - chroma-js and @types/chroma-js installed in frontend/package.json
    - getUrgencyColor returns green for new tasks, yellow/orange as deadline approaches, warm orange for overdue, gray for done/no-deadline
    - getUrgencyLevel returns correct urgency tier based on time remaining
    - isStaleTask returns true for backlog items older than 3 days
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useCountdown and useUrgencyColor hooks</name>
  <files>
    frontend/lib/hooks/useCountdown.ts
    frontend/lib/hooks/useUrgencyColor.ts
  </files>
  <action>
    1. Create `frontend/lib/hooks/useCountdown.ts`:
    - Export `useCountdown(targetDate: string | undefined)` hook
    - Returns `{ timeLeft: string | null, isOverdue: boolean }`
    - Use requestAnimationFrame (NOT setInterval -- causes drift when tab backgrounds, per RESEARCH.md pitfall 1)
    - Store rafId in useRef, lastUpdateRef in useRef for 1000ms throttling
    - On each frame: if timestamp - lastUpdate >= 1000, recalculate
    - Calculate remaining = new Date(targetDate).getTime() - Date.now()
    - If remaining <= 0: set isOverdue=true, timeLeft='overdue', stop RAF loop
    - Otherwise: use `formatDistanceToNowStrict(new Date(targetDate), { addSuffix: false })` from date-fns for display string
    - Clean up RAF in useEffect return
    - If targetDate is undefined, return { timeLeft: null, isOverdue: false } immediately

    2. Create `frontend/lib/hooks/useUrgencyColor.ts`:
    - Export `useUrgencyColor(dueDate: string | undefined, createdAt: string, status: string): string`
    - Wrap getUrgencyColor from `@/lib/urgency` in useMemo
    - Dependency array: [dueDate, createdAt, status]
    - This is a thin memoization wrapper -- the heavy logic lives in urgency.ts

    Follow existing hook patterns from useAutoSave.ts and useVoiceInput.ts (camelCase filenames, named exports, 'use client' not needed in hook files since they're imported by client components).
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` compiles without errors
    - Both files export their hooks (grep for "export function")
    - useCountdown uses requestAnimationFrame (grep for "requestAnimationFrame")
    - useCountdown does NOT use setInterval (grep should find zero matches)
    - useUrgencyColor uses useMemo (grep for "useMemo")
  </verify>
  <done>
    - useCountdown hook returns live countdown string that updates every ~1 second via requestAnimationFrame
    - useCountdown returns isOverdue: true when past deadline, stops updating
    - useCountdown handles undefined targetDate gracefully (returns null)
    - useUrgencyColor hook returns memoized hex color string based on deadline proximity
    - Both hooks follow existing project conventions (named exports, camelCase, TypeScript types)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd frontend && npx tsc --noEmit` passes
2. All exports present: urgency.ts exports getUrgencyColor, getUrgencyLevel, isStaleTask; useCountdown.ts exports useCountdown; useUrgencyColor.ts exports useUrgencyColor
3. No setInterval in countdown hook (performance requirement)
4. chroma-js in package.json dependencies
5. Overdue color is '#f97316' (orange), not pure red (ADHD-safe requirement)
</verification>

<success_criteria>
- Three new utility/hook files created and type-checking cleanly
- chroma-js installed as dependency
- Color gradient follows green -> yellow -> orange -> red via HSL interpolation
- Countdown uses requestAnimationFrame with 1-second throttle
- Overdue tasks get warm orange, not shame-inducing pure red
- All functions handle edge cases: undefined dueDate, completed tasks, stale backlog items
</success_criteria>

<output>
After completion, create `.planning/phases/03-urgency-system/03-01-SUMMARY.md`
</output>

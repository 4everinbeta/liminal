---
phase: 03-urgency-system
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - frontend/components/TaskCard.tsx
  - frontend/components/UrgencyIndicator.tsx
  - frontend/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "Tasks visually change color as deadline approaches (green to yellow to orange to red border)"
    - "Tasks display countdown timer showing time remaining in human-readable format"
    - "Overdue tasks show warm orange treatment with encouraging 'Let's finish this' framing"
    - "Tasks in backlog for 3+ days fade and desaturate (visual aging)"
    - "Due today section visible on dashboard with capacity summary"
    - "Notification soft-ask appears when user first interacts with a due-date task"
  artifacts:
    - path: "frontend/components/TaskCard.tsx"
      provides: "Task card with urgency color, countdown, and visual aging"
      contains: "useUrgencyColor"
    - path: "frontend/components/UrgencyIndicator.tsx"
      provides: "Countdown display component with urgency level styling"
      exports: ["UrgencyIndicator"]
    - path: "frontend/app/page.tsx"
      provides: "Dashboard with CapacitySummary integration"
      contains: "CapacitySummary"
  key_links:
    - from: "frontend/components/TaskCard.tsx"
      to: "frontend/lib/hooks/useUrgencyColor.ts"
      via: "useUrgencyColor hook call"
      pattern: "useUrgencyColor"
    - from: "frontend/components/TaskCard.tsx"
      to: "frontend/lib/hooks/useCountdown.ts"
      via: "useCountdown hook call"
      pattern: "useCountdown"
    - from: "frontend/components/TaskCard.tsx"
      to: "frontend/lib/urgency.ts"
      via: "isStaleTask for visual aging"
      pattern: "isStaleTask"
    - from: "frontend/components/UrgencyIndicator.tsx"
      to: "frontend/lib/hooks/useCountdown.ts"
      via: "useCountdown hook for live timer"
      pattern: "useCountdown"
    - from: "frontend/app/page.tsx"
      to: "frontend/components/CapacitySummary.tsx"
      via: "component import and render"
      pattern: "CapacitySummary"
---

<objective>
Wire all urgency features into the existing UI: urgency colors on TaskCard, countdown timers, visual aging, CapacitySummary on dashboard, and notification integration.

Purpose: This is where the urgency system becomes visible to users. Plans 01 and 02 created the engine -- this plan connects it to the UI. After this plan, users will see tasks change color as deadlines approach, live countdown timers, faded stale tasks, capacity summaries, and notification opt-in prompts.

Output: Modified TaskCard.tsx with urgency features, new UrgencyIndicator.tsx component, modified dashboard page.tsx with CapacitySummary.
</objective>

<execution_context>
@/home/rbrown/.claude/get-shit-done/workflows/execute-plan.md
@/home/rbrown/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-urgency-system/03-RESEARCH.md
@.planning/phases/03-urgency-system/03-01-SUMMARY.md
@.planning/phases/03-urgency-system/03-02-SUMMARY.md

@frontend/components/TaskCard.tsx
@frontend/app/page.tsx
@frontend/lib/api.ts (Task interface)
@frontend/lib/urgency.ts (from Plan 01)
@frontend/lib/hooks/useCountdown.ts (from Plan 01)
@frontend/lib/hooks/useUrgencyColor.ts (from Plan 01)
@frontend/components/CapacitySummary.tsx (from Plan 02)
@frontend/lib/hooks/useNotifications.ts (from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UrgencyIndicator and wire urgency into TaskCard</name>
  <files>
    frontend/components/UrgencyIndicator.tsx
    frontend/components/TaskCard.tsx
  </files>
  <action>
    1. Create `frontend/components/UrgencyIndicator.tsx` ('use client'):

    **Props:** `{ dueDate: string | undefined, size?: 'sm' | 'md' }`

    **Logic:**
    - Call useCountdown(dueDate) to get { timeLeft, isOverdue }
    - If no dueDate or timeLeft is null: render nothing (return null)
    - If isOverdue: show "Let's finish this" in warm orange text (NOT "late" or "overdue" or shame language)
    - Otherwise: show timeLeft string (e.g., "2 hours") with "left" suffix
    - Size 'sm' uses text-xs, 'md' uses text-sm

    **Styling:**
    - Overdue: `text-orange-500 font-medium` with a small clock or arrow-right icon from lucide-react
    - Critical (<1h): `text-red-500 font-medium` (red is OK for "almost now" since it creates urgency not shame)
    - Soon (<24h): `text-amber-600`
    - Safe: `text-gray-500`
    - Use getUrgencyLevel from urgency.ts to determine which style applies

    Export as default.

    2. Modify `frontend/components/TaskCard.tsx`:

    **Expand TaskProps interface** to include fields needed for urgency:
    ```
    task: {
      id: string
      title: string
      priority_score?: number
      estimatedTime?: number
      themeColor?: string
      due_date?: string      // ADD
      created_at?: string    // ADD
      status?: string        // ADD
    }
    ```

    **Add urgency color to card border:**
    - Import and call `useUrgencyColor(task.due_date, task.created_at || '', task.status || '')`
    - When task has a due_date AND no themeColor: use urgency color for the left border via inline style `{ borderLeft: '4px solid', borderLeftColor: urgencyColor }` (this replaces the priority-based color logic for tasks with deadlines)
    - When task has themeColor: keep existing theme color behavior (theme takes priority)
    - When task has no due_date and no themeColor: keep existing priority_score color classes

    **Add UrgencyIndicator:**
    - Import UrgencyIndicator component
    - Render `<UrgencyIndicator dueDate={task.due_date} size="sm" />` below the task title, next to the effort label

    **Add visual aging with Framer Motion:**
    - Import `isStaleTask` from `@/lib/urgency`
    - Calculate `const stale = isStaleTask(task.created_at || '', task.status || '')`
    - Add to the motion.div animate prop: `opacity: isCompleting ? 0 : stale ? 0.5 : 1` and `filter: stale ? 'grayscale(30%)' : 'grayscale(0%)'`
    - Add transition `{ duration: 0.5 }` for smooth aging appearance

    **Wrap with React.memo:**
    - Wrap the entire TaskCard component with React.memo() to prevent parent re-renders from countdown updates causing O(n) re-renders for n tasks (RESEARCH.md pitfall 5)
    - Keep the forwardRef pattern: `const TaskCard = React.memo(forwardRef<HTMLDivElement, TaskProps>(...))`

    IMPORTANT: Use inline styles (not dynamic Tailwind classes) for the urgency border color. Dynamic Tailwind class names like `border-l-[${color}]` will NOT work at build time (RESEARCH.md pitfall 2).
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` compiles without errors
    - TaskCard.tsx imports useUrgencyColor and useCountdown hooks (grep confirms)
    - TaskCard.tsx uses isStaleTask for aging (grep confirms)
    - TaskCard.tsx wrapped in React.memo (grep for "React.memo" or "memo(")
    - UrgencyIndicator.tsx exists and exports component
    - No shame language in UrgencyIndicator (grep for "late\|fail\|behind\|missed" finds zero)
    - No dynamic Tailwind classes for colors (grep for template literal border classes finds zero)
  </verify>
  <done>
    - TaskCard shows urgency-colored left border based on deadline proximity (green -> orange -> red gradient)
    - TaskCard shows live countdown timer via UrgencyIndicator ("2 hours left")
    - Overdue tasks show warm orange with "Let's finish this" message
    - Stale backlog tasks (3+ days) fade to 50% opacity with 30% grayscale
    - TaskCard wrapped in React.memo for performance with multiple countdown timers
    - Theme color still takes priority over urgency color when present
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate CapacitySummary and notification soft-ask into dashboard</name>
  <files>frontend/app/page.tsx</files>
  <action>
    Read the current `frontend/app/page.tsx` dashboard to understand its structure, then:

    1. **Add CapacitySummary to dashboard:**
    - Import CapacitySummary from `@/components/CapacitySummary`
    - Render `<CapacitySummary tasks={tasks} />` at the top of the task list area, above the sorted task cards
    - Position it as a summary card: `<div className="mb-4"><CapacitySummary tasks={tasks} /></div>`

    2. **Add notification soft-ask prompt:**
    - Import useNotifications from `@/lib/hooks/useNotifications`
    - Call useNotifications() in the dashboard component
    - When user interacts with a task that has a due_date (e.g., completes it, or when tasks load and some have due dates), check if notification permission is 'default' and show the soft-ask
    - Render soft-ask as a dismissible banner at the top of the page:
      ```
      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between mb-4">
        <span className="text-sm text-blue-800">Get reminded 1 hour before deadlines?</span>
        <div className="flex gap-2">
          <button onClick={requestPermission} className="text-sm bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700">Enable</button>
          <button onClick={dismissSoftAsk} className="text-sm text-blue-600 hover:text-blue-800">Not now</button>
        </div>
      </div>
      ```
    - Only show the soft-ask banner ONCE: after user dismisses, store dismissal in sessionStorage so it doesn't reappear in the same session
    - Trigger soft-ask display: use a useEffect that checks if any tasks have due_dates AND permission is 'default' AND user hasn't dismissed yet. If all true, show the banner.

    3. **Schedule notifications for tasks with due dates:**
    - After tasks load (in existing useEffect or data fetching logic), if notification permission is 'granted', iterate tasks with due_dates and call scheduleNotification for each
    - This happens silently after permission is already granted -- no user interaction needed

    IMPORTANT: Do NOT auto-request notification permission. The soft-ask banner is the ONLY trigger for the browser permission dialog, and it only appears after user gesture (clicking "Enable").
  </action>
  <verify>
    - `cd frontend && npx tsc --noEmit` compiles without errors
    - page.tsx imports and renders CapacitySummary (grep confirms)
    - page.tsx imports useNotifications (grep confirms)
    - Soft-ask banner has explicit user-triggered button for permission request
    - No bare Notification.requestPermission() calls outside of click handlers
    - `cd frontend && npm run build` completes without errors (full build test)
  </verify>
  <done>
    - Dashboard shows CapacitySummary with "X.Xh left, N of M tasks fit" above task list
    - Notification soft-ask banner appears once when tasks with due dates are present and permission is 'default'
    - "Enable" button triggers browser notification permission dialog
    - "Not now" dismisses banner for the session
    - Tasks with due dates get notifications scheduled (1 hour before) when permission is granted
    - Build succeeds with all urgency features integrated
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete urgency system: tasks show deadline-based color gradients (green to red), live countdown timers ("2 hours left"), warm orange overdue treatment with "Let's finish this" messaging, stale backlog task fading, "Due Today" capacity summary, and browser notification opt-in.
  </what-built>
  <how-to-verify>
    1. Start the app (`docker compose up` or `cd frontend && npm run dev`)
    2. Create a task with a due date set to 2 hours from now -- verify:
       - Left border shows yellow-orange color (approaching deadline)
       - Countdown shows "about 2 hours left" below the title
    3. Create a task with a due date in the past -- verify:
       - Left border is warm orange (not pure red)
       - Shows "Let's finish this" message (not shame language)
    4. Create a task with a due date tomorrow -- verify:
       - Left border is green/green-yellow (safe)
       - Countdown shows "about 1 day left"
    5. Check the "Due Today" capacity card at the top -- verify:
       - Shows hours remaining in workday
       - Shows task count that fits
    6. Look for the notification banner -- verify:
       - "Get reminded 1 hour before deadlines?" appears
       - Click "Not now" -- banner disappears
       - Refresh page -- banner does NOT reappear
    7. If a task has been in backlog for 3+ days (or fake it by adjusting created_at) -- verify:
       - Task card is visually faded (50% opacity, slight grayscale)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript: `cd frontend && npx tsc --noEmit` passes
2. Build: `cd frontend && npm run build` succeeds
3. All 6 success criteria from roadmap addressed:
   - URGENCY-01: Tasks change color as deadline approaches (urgency border color)
   - URGENCY-02: Tasks show countdown timer ("X hours left")
   - URGENCY-03: Overdue tasks have warm orange treatment, not shame-inducing
   - URGENCY-04: "Due today" capacity section on dashboard
   - URGENCY-05: Tasks fade after 3 days in backlog (visual aging)
   - URGENCY-06: Browser notification 1 hour before deadline (opt-in)
4. No shame language anywhere in new code
5. No dynamic Tailwind classes for colors (inline styles used)
6. TaskCard wrapped in React.memo for performance
</verification>

<success_criteria>
- Tasks visually shift from green to red as deadlines approach
- Countdown timers display live "X hours left" on tasks with due dates
- Overdue tasks show warm orange with "Let's finish this" (no shame)
- "Due Today" capacity summary visible on dashboard
- Stale backlog tasks fade visually after 3 days
- Notification opt-in works via soft-ask banner, never auto-prompts
- User visually confirms all urgency features working correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-urgency-system/03-03-SUMMARY.md`
</output>
